<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Splat Plate â€” Viewer</title>

  <!-- PlayCanvas web components -->
  <script type="importmap">
  { "imports": { "playcanvas": "https://cdn.jsdelivr.net/npm/playcanvas@latest/build/playcanvas.mjs" } }
  </script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@playcanvas/web-components@latest/dist/pwc.mjs"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#0b0b0b; }
    * { box-sizing: border-box; }
    .wrap { position:fixed; inset:0; }
    pc-app { position:absolute; inset:0; display:block; touch-action:none; user-select:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- lighter = smoother -->
    <pc-app antialias="false" high-resolution="false" alpha="false" depth="false" stencil="false">
      <!-- Assets (load your splat from THIS repo) -->
      <pc-asset id="plate" src="./export_ply.sog"></pc-asset>
      <pc-asset id="cameraControls"
        src="https://cdn.jsdelivr.net/npm/playcanvas@latest/scripts/esm/camera-controls.mjs"></pc-asset>

      <!-- Scene -->
      <pc-scene>
        <pc-entity id="camRig" position="0 0 0" rotation="-28 16 0">
          <pc-entity id="camera" position="0 0 2.3">
            <pc-camera clear-color="#0b0b0b" fov="40"></pc-camera>
            <pc-scripts>
              <pc-script name="cameraControls" attributes='{
                "enableFly": false,
                "enablePan": false,
                "focusPoint": "vec3:0,0,0",
                "pitchRange": "vec2:-80,-10",
                "sceneSize": 3,
                "zoomRange": "vec2:1.6,3.2"
              }'></pc-script>
            </pc-scripts>
          </pc-entity>
        </pc-entity>

        <pc-entity id="splat" position="0 0 0" rotation="180 0 0" scale="2.8 2.8 2.8">
          <pc-splat asset="plate"></pc-splat>
        </pc-entity>
      </pc-scene>
    </pc-app>
  </div>

  <!-- ADD THIS: place the script right before </body> -->
  <script type="module">
  const appEl = document.querySelector('pc-app');

  function init() {
    const app = appEl.app;
    if (!app) return false;

    const camRig  = app.root.findByName('camRig');
    const camera  = app.root.findByName('camera');
    if (!camRig || !camera) return false;

    // Your preferred pose (already in the scene)
    const HOME_RIG_EULER = camRig.getLocalEulerAngles().clone();
    const HOME_CAM_POS   = camera.getLocalPosition().clone();

    const Z_MIN = 1.6, Z_MAX = 3.2;

    // Track touches to do pinch zoom ourselves (no pan)
    const active = new Map();
    let lastPinchDist = null;
    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    const dist2 = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
    const touches = () => [...active.values()];

    // 1) BRUTE FORCE: kill any pan drift every frame
    app.on('update', () => {
      // Rig must stay at origin
      const lp = camRig.getLocalPosition();
      if (lp.x !== 0 || lp.y !== 0 || lp.z !== 0) camRig.setLocalPosition(0,0,0);

      // Camera must not slip sideways
      const cp = camera.getLocalPosition();
      if (cp.x !== 0 || cp.y !== 0) camera.setLocalPosition(0,0,cp.z);
    });

    // 2) Swallow two-finger gestures and convert to pinch-zoom (only Z)
    const target = appEl;                        // host element covers the canvas
    const opts   = { passive:false, capture:true };

    target.addEventListener('pointerdown', ev => {
      if (ev.pointerType !== 'touch') return;
      active.set(ev.pointerId, { x: ev.clientX, y: ev.clientY });
    }, opts);

    target.addEventListener('pointermove', ev => {
      if (ev.pointerType !== 'touch') return;

      if (active.has(ev.pointerId)) {
        active.set(ev.pointerId, { x: ev.clientX, y: ev.clientY });
      }
      const ts = touches();

      // Two fingers: block pan + do our own zoom
      if (ts.length === 2) {
        ev.preventDefault();
        ev.stopImmediatePropagation();

        const d = dist2(ts[0], ts[1]);
        if (lastPinchDist == null) { lastPinchDist = d; return; }

        const dz = (lastPinchDist - d) * 0.003;     // zoom sensitivity
        lastPinchDist = d;

        const lp = camera.getLocalPosition();
        const z  = clamp(lp.z + dz, Z_MIN, Z_MAX);
        camera.setLocalPosition(0, 0, z);           // lock x/y = 0 here too

        // Make sure rig never budges
        camRig.setLocalPosition(0,0,0);
      }
    }, opts);

    const endLike = ev => {
      if (ev.pointerType !== 'touch') return;
      active.delete(ev.pointerId);
      const ts = touches();
      if (ts.length < 2) lastPinchDist = null;

      // Optional: snap angle back when fingers leave (keeps user zoom)
      if (ts.length === 0) {
        const startEuler = camRig.getLocalEulerAngles().clone();
        const startPos   = camera.getLocalPosition().clone();
        const startTime  = performance.now(), dur = 150;

        (function animate(t){
          const k = Math.min(1, (t - startTime)/dur);
          const e = 1 - Math.pow(1-k, 3);
          camRig.setLocalEulerAngles(
            startEuler.x + (HOME_RIG_EULER.x - startEuler.x)*e,
            startEuler.y + (HOME_RIG_EULER.y - startEuler.y)*e,
            startEuler.z + (HOME_RIG_EULER.z - startEuler.z)*e
          );
          camera.setLocalPosition(0,0,startPos.z);  // keep zoom, lock x/y
          if (k < 1) requestAnimationFrame(animate);
        })(startTime);
      }
    };

    target.addEventListener('pointerup', endLike, opts);
    target.addEventListener('pointercancel', endLike, opts);
    target.addEventListener('pointerout', endLike, opts);
    target.addEventListener('pointerleave', endLike, opts);

    // Block default multi-touch behaviors on some browsers
    target.addEventListener('touchstart', e => {
      if (e.touches.length > 1) { e.preventDefault(); e.stopImmediatePropagation(); }
    }, opts);

    return true;
  }

  // Wait until pc-app is initialized
  const boot = () => { if (!init()) requestAnimationFrame(boot); };
  if (appEl.app) init(); else boot();
</script>
</body>
</html>
