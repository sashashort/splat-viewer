<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Splat Plate â€” Viewer</title>

  <!-- PlayCanvas web components -->
  <script type="importmap">
  { "imports": { "playcanvas": "https://cdn.jsdelivr.net/npm/playcanvas@latest/build/playcanvas.mjs" } }
  </script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@playcanvas/web-components@latest/dist/pwc.mjs"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#0b0b0b; }
    * { box-sizing: border-box; }
    .wrap { position:fixed; inset:0; }
    pc-app { position:absolute; inset:0; display:block; touch-action:none; user-select:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- lighter = smoother -->
    <pc-app antialias="false" high-resolution="false" alpha="false" depth="false" stencil="false">
      <!-- Assets (load your splat from THIS repo) -->
      <pc-asset id="plate" src="./export_ply.sog"></pc-asset>
      <pc-asset id="cameraControls"
        src="https://cdn.jsdelivr.net/npm/playcanvas@latest/scripts/esm/camera-controls.mjs"></pc-asset>

      <!-- Scene -->
      <pc-scene>
        <pc-entity id="camRig" position="0 0 0" rotation="-28 16 0">
          <pc-entity id="camera" position="0 0 2.3">
            <pc-camera clear-color="#0b0b0b" fov="40"></pc-camera>
            <pc-scripts>
              <pc-script name="cameraControls" attributes='{
                "enableFly": false,
                "enablePan": false,
                "focusPoint": "vec3:0,0,0",
                "pitchRange": "vec2:-80,-10",
                "sceneSize": 3,
                "zoomRange": "vec2:1.6,3.2"
              }'></pc-script>
            </pc-scripts>
          </pc-entity>
        </pc-entity>

        <pc-entity id="splat" position="0 0 0" rotation="180 0 0" scale="2.8 2.8 2.8">
          <pc-splat asset="plate"></pc-splat>
        </pc-entity>
      </pc-scene>
    </pc-app>
  </div>

  <!-- ADD THIS: place the script right before </body> -->
  <script type="module">
    const appEl = document.querySelector('pc-app');

    function init() {
      const app = appEl.app;
      if (!app) return false;

      const camRig = app.root.findByName('camRig');
      const camera = app.root.findByName('camera');
      if (!camRig || !camera) return false;

      const home = {
        rigEuler: camRig.getLocalEulerAngles().clone(),
        camLocal: camera.getLocalPosition().clone()
      };

      const Z_MIN = 1.6, Z_MAX = 3.2;
      const active = new Map();
      let lastPinchDist = null;
      let snapping = false;

      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const dist2 = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);
      const getTouches = () => [...active.values()];

      function snapHome() {
        if (snapping) return;
        snapping = true;
        const dur = 180;
        const start = performance.now();
        const startEuler = camRig.getLocalEulerAngles().clone();
        const startPos = camera.getLocalPosition().clone();

        const tick = (now) => {
          const k = clamp((now - start) / dur, 0, 1);
          const e = 1 - Math.pow(1 - k, 3);

          camRig.setLocalEulerAngles(
            startEuler.x + (home.rigEuler.x - startEuler.x) * e,
            startEuler.y + (home.rigEuler.y - startEuler.y) * e,
            startEuler.z + (home.rigEuler.z - startEuler.z) * e
          );

          camera.setLocalPosition(startPos.x, startPos.y, startPos.z);

          if (k < 1) requestAnimationFrame(tick);
          else snapping = false;
        };
        requestAnimationFrame(tick);
      }

      const target = appEl;
      const opts = { passive: false, capture: true };

      target.addEventListener('pointerdown', (ev) => {
        if (ev.pointerType !== 'touch') return;
        active.set(ev.pointerId, { x: ev.clientX, y: ev.clientY });
      }, opts);

      target.addEventListener('pointermove', (ev) => {
        if (ev.pointerType !== 'touch') return;
        if (active.has(ev.pointerId)) {
          active.set(ev.pointerId, { x: ev.clientX, y: ev.clientY });
        }
        const touches = getTouches();

        if (touches.length === 2) {
          ev.preventDefault();
          ev.stopImmediatePropagation();

          const d = dist2(touches[0], touches[1]);
          if (lastPinchDist == null) { lastPinchDist = d; return; }

          const dz = (lastPinchDist - d) * 0.003;
          lastPinchDist = d;

          const lp = camera.getLocalPosition();
          const z = clamp(lp.z + dz, Z_MIN, Z_MAX);
          camera.setLocalPosition(lp.x, lp.y, z);

          camRig.setLocalPosition(0, 0, 0);
          return;
        }

        camRig.setLocalPosition(0, 0, 0);
      }, opts);

      const endLike = (ev) => {
        if (ev.pointerType !== 'touch') return;
        active.delete(ev.pointerId);
        const touches = getTouches();
        if (touches.length < 2) lastPinchDist = null;
        if (touches.length === 0) {
          camRig.setLocalPosition(0, 0, 0);
          snapHome();
        }
      };

      target.addEventListener('pointerup', endLike, opts);
      target.addEventListener('pointercancel', endLike, opts);
      target.addEventListener('pointerout', endLike, opts);
      target.addEventListener('pointerleave', endLike, opts);

      target.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) { e.preventDefault(); e.stopImmediatePropagation(); }
      }, opts);

      return true;
    }

    // Make sure pc-app is ready
    const tryInit = () => {
      if (!init()) requestAnimationFrame(tryInit);
    };
    tryInit();
  </script>
</body>
</html>
