<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Splat Plate â€” Viewer</title>

  <!-- PlayCanvas + web components -->
  <script type="importmap">
  { "imports": { "playcanvas": "https://cdn.jsdelivr.net/npm/playcanvas@latest/build/playcanvas.mjs" } }
  </script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@playcanvas/web-components@latest/dist/pwc.mjs"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:#0b0b0b; }
    * { box-sizing: border-box; }
    .wrap { position:fixed; inset:0; }
    pc-app { position:absolute; inset:0; display:block; touch-action:none; user-select:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <pc-app antialias="false" high-resolution="false" alpha="false" depth="false" stencil="false">
      <!-- Assets -->
      <pc-asset id="plate" src="./export_ply.sog"></pc-asset>

      <!-- Scene -->
      <pc-scene>
        <pc-entity id="camRig" position="0 0 0" rotation="-28 16 0">
          <pc-entity id="camera" position="0 0 2.3">
            <pc-camera clear-color="#0b0b0b" fov="40"></pc-camera>
          </pc-entity>
        </pc-entity>

        <pc-entity id="splat" position="0 0 0" rotation="180 0 0" scale="2.8 2.8 2.8">
          <pc-splat asset="plate"></pc-splat>
        </pc-entity>
      </pc-scene>
    </pc-app>
  </div>

  <!-- Direct input wiring: rotate + pinch-zoom, NO PAN -->
  <script type="module">
    import * as pc from "playcanvas";

    window.addEventListener("pcstart", (e) => {
      const app = e.detail.app;
      const cam = app.root.findByName("camera");
      if (!cam) return;

      // Spherical camera state
      const focus = new pc.Vec3(0,0,0);
      let dist  = 2.3;                      // start distance
      let yaw   = 16 * pc.math.DEG_TO_RAD;  // match your rig
      let pitch = -28 * pc.math.DEG_TO_RAD;
      const distMin = 1.6, distMax = 3.2;
      const pitchMin = -80 * pc.math.DEG_TO_RAD, pitchMax = -10 * pc.math.DEG_TO_RAD;

      const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
      const apply = () => {
        const x = focus.x + dist * Math.cos(pitch) * Math.sin(yaw);
        const y = focus.y + dist * Math.sin(pitch);
        const z = focus.z + dist * Math.cos(pitch) * Math.cos(yaw);
        cam.setLocalPosition(x, y, z);
        cam.lookAt(focus);
      };
      apply();

      // ------- DESKTOP (no pan) -------
      let dragging = false;
      app.mouse?.on(pc.EVENT_MOUSEDOWN, (ev) => { if (ev.button === 0) dragging = true; }, this);
      app.mouse?.on(pc.EVENT_MOUSEUP,   () => { dragging = false; }, this);
      app.mouse?.on(pc.EVENT_MOUSEMOVE, (ev) => {
        if (!dragging) return;
        yaw   -= ev.dx * 0.0025;
        pitch -= ev.dy * 0.0025;
        pitch = clamp(pitch, pitchMin, pitchMax);
        apply();
      }, this);
      app.mouse?.on(pc.EVENT_MOUSEWHEEL, (ev) => {
        dist += ev.deltaY * 0.003 * dist;
        dist = clamp(dist, distMin, distMax);
        apply();
      }, this);

      // ------- MOBILE (rotate + pinch-zoom, NO PAN) -------
      const t = { rotating:false, lx:0, ly:0, lastPinch:null };
      app.touch?.on(pc.EVENT_TOUCHSTART, (ev) => {
        if (ev.touches.length === 1) {
          const a = ev.touches[0]; t.rotating = true; t.lx = a.x; t.ly = a.y;
        } else if (ev.touches.length === 2) {
          const [a,b] = ev.touches; t.lastPinch = Math.hypot(b.x - a.x, b.y - a.y);
        }
        ev.event?.preventDefault();
      }, this);

      app.touch?.on(pc.EVENT_TOUCHMOVE, (ev) => {
        if (ev.touches.length === 1 && t.rotating) {
          const a = ev.touches[0];
          const dx = a.x - t.lx, dy = a.y - t.ly;
          t.lx = a.x; t.ly = a.y;
          yaw   -= dx * 0.002;
          pitch -= dy * 0.002;
          pitch = clamp(pitch, pitchMin, pitchMax);
          apply();
        } else if (ev.touches.length === 2) {
          const [a,b] = ev.touches;
          const d = Math.hypot(b.x - a.x, b.y - a.y);
          if (t.lastPinch != null) {
            const delta = d - t.lastPinch;
            dist -= (delta * 0.0005) * dist; // pinch zoom
            dist = clamp(dist, distMin, distMax);
            apply();
          }
          t.lastPinch = d;
        }
        ev.event?.preventDefault(); // critical to block browser/iframe panning
      }, this);

      const end = () => { t.rotating = false; t.lastPinch = null; };
      app.touch?.on(pc.EVENT_TOUCHEND, end, this);
      app.touch?.on(pc.EVENT_TOUCHCANCEL, end, this);
    });
  </script>
</body>
</html>
